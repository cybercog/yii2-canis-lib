<?php
/**
 *
 *
 * @link http://www.yiiframework.com/
 * @copyright Copyright (c) 2008 Yii Software LLC
 * @license http://www.yiiframework.com/license/
 * @author Jacob Morrison <jacob@infinitecascade.com>
 * @package infinite
 */


namespace yii\build\controllers;

use yii\console\Controller;
use yii\helpers\FileHelper;

/**
 *
 *
 * @author Qiang Xue <qiang.xue@gmail.com>
 * @since 2.0
 */
class ClassmapController extends Controller
{
    public $defaultAction = 'create';

    /**
     * Creates a class map for the core Yii classes.
     *
     * @param string  $root    (optional) the root path of Yii framework. Defaults to YII_PATH.
     * @param string  $mapFile (optional) the file to contain the class map. Defaults to YII_PATH . '/classes.php'.
     * @return unknown
     */
    public function actionCreate($root = null, $mapFile = null)
    {
        if ($root === null) {
            $root = dirname(dirname(dirname(__FILE__))) . DIRECTORY_SEPARATOR . 'library';
        }
        $root = FileHelper::normalizePath($root);
        if ($mapFile === null) {
            $mapFile = dirname(dirname(dirname(__FILE__))) . DIRECTORY_SEPARATOR . 'classes.php';
        }
        $options = [

            /**
             *
             */
            'filter' => function ($path) {
                if (is_file($path)) {
                    $file = basename($path);
                    if ($file[0] < 'A' || $file[0] > 'Z') {
                        return false;
                    }
                }
                return null;
            },
            'only' => ['.php']
        ];
        $files = FileHelper::findFiles($root, $options);
        $map = [];
        foreach ($files as $file) {
            if (($pos = strpos($file, $root)) !== 0) {
                die("Something wrong: $file\n");
            }
            $path = substr($file, strlen($root));
            $map[$path] = "\t'infinite" . substr(str_replace('/', '\\', $path), 0, -4) . "' => INFINITE_CORE_PATH . '$path',";
        }
        ksort($map);
        $map = implode("\n", $map);
        $output = <<<EOD
<?php
/**
 * Infinite core class map.
 *
 * This file is automatically generated by the "build classmap" command under the "build" folder.
 * Do not modify it directly.
 *
 * @link http://www.infinitecascade.com/
 * @copyright Copyright (c) 2013 Infinite Cascade
 * @license http://www.infinitecascade.com/license
 */
defined('INFINITE_CORE_PATH') OR define('INFINITE_CORE_PATH', dirname(__FILE__) . DIRECTORY_SEPARATOR . 'library');
return [
$map
];

EOD;
        if (is_file($mapFile) && file_get_contents($mapFile) === $output) {
            echo "Nothing changed.\n";
        } else {
            file_put_contents($mapFile, $output);
            echo "Class map saved in $mapFile\n";
        }
    }


}
